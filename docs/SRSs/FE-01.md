# FE-01: Authentication (Đăng nhập)

## 1. Tổng quan

Module này xử lý quy trình Xác thực (Authentication) cho trang quản trị (Admin Dashboard). Đây là điểm truy cập đầu tiên để quản trị viên vào hệ thống.
Tương ứng với logic Backend tại `BE-02` (Admin Authentication) và Postman endpoint `Authentication -> Login`.

## 2. Đặc tả giao diện (UI Specifications)

### Các thành phần (Components)

- **Login Page Layout**: Bố cục căn giữa, gọn gàng, có hình nền hoặc màu nền đơn giản.
- **Login Card**: Khung chứa form đăng nhập.
- **Input Fields**:
  - `Username` (Type: Text, Placeholder: "admin123")
  - `Password` (Type: Password, Placeholder: "**\*\***")
- **Buttons**:
  - `Login` (Nút chính - Primary Button)
- **Feedback Elements (Phản hồi)**:
  - `Error Alert`: Hiển thị lỗi validate hoặc lỗi từ API (ví dụ: "Username hoặc mật khẩu không đúng").
  - `Loading Spinner`: Hiển thị bên trong nút Login khi đang xử lý request.

### Ánh xạ dữ liệu (Data Mapping)

| Nhãn trường (Label) | Tên biến FE | Key Payload (API) | Kiểu     | Validate (FE)               |
| :------------------ | :---------- | :---------------- | :------- | :-------------------------- |
| Username            | `username`  | `username`        | Text     | Bắt buộc, Tối thiểu 6 ký tự |
| Password            | `password`  | `password`        | Password | Bắt buộc, Tối thiểu 6 ký tự |

## 3. Luồng xử lý & Tương tác (Flow & Interaction)

### Luồng chính (Theo auth_flow.puml)

1. **Truy cập**: Người dùng vào đường dẫn `/login`.
2. **Nhập liệu**: Người dùng nhập `Username` và `Password`.
3. **Gửi form**: Người dùng nhấn nút "Login".
   - UI chuyển sang trạng thái loading (disable nút, hiện spinner).
   - Thực hiện validate phía client (kiểm tra các trường bắt buộc).

4. **Xử lý Backend (Qua NextAuth)**:
   - Frontend gọi `signIn("Credentials", { username, password })`.
   - NextAuth Route Handler (`/api/auth/callback/credentials`) nhận request.
   - NextAuth `authorize()` callback gửi `POST ${BACKEND_URL}/api/auth/login` với `{username, password}`.
   
5. **Backend Validation**:
   - Backend validate input (Zod).
   - **Nếu Input Invalid**: Backend trả về `400 Bad Request` → Frontend hiển thị lỗi validate.
   - **Nếu Input Valid**: Backend tìm user trong database.
   
6. **Backend Authentication**:
   - **Nếu User Not Found**: Backend trả về `401 Unauthorized` với message "Invalid credentials" → Frontend hiển thị lỗi.
   - **Nếu User Found**: Backend so sánh password (bcrypt).
     - **Nếu Password Mismatch**: Backend trả về `401 Unauthorized` với message "Invalid credentials" → Frontend hiển thị lỗi.
     - **Nếu Password Match**: Backend generate JWT token và trả về `200 OK` với `{ success: true, token: "...", user: { id, username, role } }`.

7. **Thành công**:
   - NextAuth nhận token từ Backend.
   - NextAuth tạo session và lưu token vào HTTP-only cookie.
   - Frontend nhận kết quả `result.ok === true`.
   - Frontend chuyển hướng (Redirect) người dùng đến Dashboard (`/dashboard`).
   - Hiển thị thông báo thành công (Toast/Snackbar).

8. **Thất bại**:
   - Nếu API trả về lỗi (`400`, `401`, `500`):
     - Tắt trạng thái loading.
     - Hiển thị thông báo lỗi từ API (ví dụ: "Username hoặc mật khẩu không đúng") trong component Error Alert/Toast.

### Quy tắc Validate

- **Username**: Không được để trống, tối thiểu 6 ký tự.
- **Password**: Không được để trống, tối thiểu 6 ký tự.

## 4. Chi tiết triển khai kỹ thuật (Technical Implementation Details)

### Tích hợp API

- **Endpoint**: `POST ${process.env.BACKEND_URL}/api/auth/login`
- **Method**: `POST`
- **Content-Type**: `application/json`

### Chiến lược Fetching Data

- **Tính năng Framework**: Sử dụng **NextAuth.js** (Credentials Provider) để xử lý authentication và session management.
- **Phương pháp đề xuất**:
  1. Cấu hình NextAuth Provider trong `src/lib/auth.ts`:
     - Tạo `CredentialsProvider` với `authorize()` callback.
     - Trong `authorize()`: Gửi `POST ${BACKEND_URL}/api/auth/login` với `{username, password}`.
     - Parse response từ Backend: `{ success, token, user }`.
     - Return object user cho NextAuth: `{ id, name, email, role, accessToken }`.
  2. Tại Client Component (`LoginForm`):
     - Sử dụng `signIn("Credentials", { username, password, redirect: false })` từ `next-auth/react`.
     - Sử dụng `useTransition` để quản lý loading state.
     - Khi `result.ok === true`: Hiển thị toast success và gọi `router.push('/dashboard')`.
     - Khi `result.error`: Hiển thị toast error với message từ `result.error`.
  3. Session Management:
     - NextAuth tự động lưu session vào HTTP-only cookie.
     - JWT strategy: Token được lưu trong session JWT.
     - Middleware kiểm tra session và redirect nếu chưa đăng nhập.

### Xử lý lỗi (Error Handling)

- Bắt lỗi `401` để hiển thị "Sai thông tin đăng nhập".
- Bắt lỗi `500` hoặc lỗi mạng để hiển thị "Lỗi hệ thống, vui lòng thử lại".

## 5. Git Branch

**Branch name**: `feature/FE-01-authentication`