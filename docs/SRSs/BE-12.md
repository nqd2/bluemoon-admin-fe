### PHẦN 1: TÀI LIỆU KỸ THUẬT (SRS) CHO TICKET [BE-12]

#### **Ticket: [BE-12] Calculate Fee for Apartment (Tính phí cho hộ)**

**1. Thông tin chung**

* **Assignee:** Backend Dev
* **Branch Name:** `feature/BE-12-calculate-fee`
* **Estimated Time:** 3h

**2. Mô tả (Description)**
API tính toán số tiền cần đóng cho một hộ gia đình đối với một khoản phí cụ thể. Đây là bước đệm trước khi tạo giao dịch (Transaction), giúp Admin biết số tiền cần thu.

**3. Yêu cầu kỹ thuật (Technical Specs)**

*   **Endpoint:** `POST /api/transactions/calculate`
*   **Authentication:** Yêu cầu `Bearer Token`.
*   **Payload:**
    ```json
    {
      "apartmentId": "apt_id_123",
      "feeId": "fee_id_456"
    }
    ```

**4. Business Logic (Chi tiết)**

1.  **Fetch Data:**
    *   Lấy thông tin `Apartment` theo `apartmentId`. (Cần populate `members` để đếm số khẩu).
    *   Lấy thông tin `Fee` theo `feeId`.
2.  **Validation:**
    *   Nếu `Apartment` hoặc `Fee` không tồn tại -> Trả về 404.
3.  **Calculation Formula:**
    *   **Case 1: Unit = 'm2'**
        *   `total = Fee.amount * Apartment.area`
    *   **Case 2: Unit = 'khẩu' (per person)**
        *   `total = Fee.amount * Apartment.members.length`
        *   *Lưu ý:* Cần kiểm tra xem `members` có bao gồm những người "Đã chuyển đi" hay không. Logic chuẩn: Chỉ đếm những người có `status` là "Thường trú" hoặc "Tạm trú" trong bảng Residents (hoặc lọc trong mảng members nếu đã populate đủ).
    *   **Case 3: Unit = 'hộ' (per apartment)**
        *   `total = Fee.amount`
4.  **Contribution Fee:**
    *   Nếu `Fee.type` là `Contribution`, API trả về `amount` mặc định (hoặc 0), nhưng Frontend sẽ cho phép Admin nhập tay số tiền thực đóng.

**5. Acceptance Criteria**

* [ ] **Accuracy:** Tính toán chính xác theo công thức trên.
* [ ] **Response:** Trả về JSON chứa:
    ```json
    {
      "apartment": "P101",
      "fee": "Phí dịch vụ",
      "unitPrice": 5000,
      "quantity": 80.5, // Diện tích hoặc số người
      "totalAmount": 402500
    }
    ```
* [ ] **Edge Cases:**
    *   Hộ không có người (members = 0) -> Phí theo đầu người = 0.
    *   Diện tích chưa cập nhật (area = null/0) -> Cảnh báo hoặc tính = 0.

**6. Error Handling**

*   `404 Not Found`: "Apartment not found" or "Fee not found".
