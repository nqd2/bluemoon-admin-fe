# FE-04: Quản lý Khoản thu (Fee Management)

## 1. Tổng quan

Module này xử lý việc tạo và quản lý các Khoản thu (Phí dịch vụ, Phí đóng góp, v.v.) và cho phép theo dõi tình trạng đóng phí của từng hộ.
Tương ứng với các ticket Backend: `BE-10`, `BE-11`, `BE-14`.

## 2. Đặc tả giao diện (UI Specifications)

### Các thành phần (Components)

- **Fee List Page (Danh sách khoản thu)**:

  - **Tabs/Filters**: "Phí dịch vụ" vs "Phí đóng góp" (Tùy chọn).
  - **Bảng (Table)**:
    - `Tên khoản thu` (Title - Vd: "Tiền điện T10").
    - `Loại` (Type - Service/Contribution).
    - `Đơn giá` (Amount).
    - `Đơn vị` (Unit - Vd: "người", "m2", "hộ").
    - `Hành động`: "Xem tình trạng" (Icon con mắt).

- **Create Fee Form (Tạo khoản thu)**:

  - `Tên khoản thu`: Text.
  - `Mô tả`: Textarea.
  - `Loại phí`: Select (Service, Contribution).
  - `Đơn giá`: Number.
  - `Đơn vị tính`: Select/Text (m2, person, household).

- **Fee Status Detail Page (Chi tiết tình trạng thu - Xem BE-14)**:
  - **Header**: Thông tin khoản thu (Tên, Đơn giá).
  - **Stats Card**: `Tổng đã thu` (Tiền tệ).
  - **Payment Table (Bảng thanh toán)**:
    - `Căn hộ` (Tên).
    - `Chủ hộ` (Tên).
    - `Trạng thái` (Badge: Đã đóng / Chưa đóng).
    - `Số tiền đã đóng`.
    - `Ngày đóng`.

### Ánh xạ dữ liệu (Data Mapping)

| Nhãn trường (Label) | Tên biến FE   | Key Payload (API) | Kiểu   |
| :------------------ | :------------ | :---------------- | :----- |
| Tên khoản thu       | `title`       | `title`           | String |
| Mô tả               | `description` | `description`     | String |
| Loại                | `type`        | `type`            | Enum   |
| Đơn giá             | `amount`      | `amount`          | Number |
| Đơn vị              | `unit`        | `unit`            | String |

## 3. Luồng xử lý & Tương tác (Flow & Interaction)

### 3.1. Tạo Khoản thu (Theo fee_payment_flow.puml)

1. Click "Tạo Khoản thu".
2. Nhập thông tin chi tiết (title, description, type, amount, unit, ...).
3. Frontend validate phía client (zod).
4. Submit `POST ${BACKEND_URL}/api/fees` với payload `{ title, description, type, amount, unit, ... }`.
5. **Backend xử lý**:
   - Backend validate input.
   - Backend insert Fee vào database.
   - Backend trả về `201 Created` với `{ success: true, data: Fee }`.
6. Frontend nhận response thành công:
   - Chuyển hướng về Danh sách (`/fees`).
   - Hiển thị Toast "Tạo khoản thu thành công".

### 3.2. Xem Tình trạng đóng phí (Theo fee_payment_flow.puml)

1. Tại Danh sách khoản thu, click "Xem tình trạng" (icon con mắt).
2. Điều hướng đến `/fees/[id]` hoặc `/fees/[id]/status`.
3. Fetch dữ liệu `GET ${BACKEND_URL}/api/fees/:id/status` (Tương ứng BE-14).
4. **Backend xử lý** (Aggregation Logic):
   - Backend lấy tất cả Apartments.
   - Backend lấy tất cả Transactions cho Fee này.
   - Backend map/merge để tìm các apartment đã đóng vs chưa đóng.
   - Backend trả về `200 OK` với:
     ```
     {
       success: true,
       data: {
         feeInfo: { title, amount, unit, ... },
         apartments: [
           { apartmentId, apartmentName, ownerName, status: "PAID" | "UNPAID", paidAmount?, paidDate?, ... },
           ...
         ]
       }
     }
     ```
5. Frontend hiển thị:
   - **Header**: Thông tin khoản thu (Tên, Đơn giá, Đơn vị).
   - **Stats Card**: Tổng đã thu (tổng của các transaction có status = "PAID").
   - **Payment Table**: Danh sách tất cả căn hộ với trạng thái (Badge: "Đã đóng" / "Chưa đóng"), số tiền đã đóng, ngày đóng.

## 4. Chi tiết triển khai kỹ thuật (Technical Implementation Details)

### API Endpoints

- **List**: `GET ${BACKEND_URL}/api/fees?type={type}&limit={limit}&page={page}`
  - Response: `{ data: Fee[], pagination: { page, limit, total } }`
- **Create**: `POST ${BACKEND_URL}/api/fees`
  - Request Body: `{ title, description, type, amount, unit, isActive?, ... }`
  - Response: `201 Created` với `{ success: true, data: Fee }`
- **Status Detail**: `GET ${BACKEND_URL}/api/fees/:id/status`
  - Response: `{ success: true, data: { feeInfo: Fee, apartments: Array<ApartmentStatus> } }`
  - **ApartmentStatus**: `{ apartmentId, apartmentName, ownerName, status: "PAID" | "UNPAID", paidAmount?, paidDate?, transactionId? }`

### Logic Chi tiết

- Endpoint Status Detail trả về object phức tạp gồm `feeInfo` và danh sách `apartments`.
- **Frontend Formatting**:
  - Tiền tệ: Format VND.
  - Ngày tháng: Format DD/MM/YYYY.
  - Màu sắc trạng thái: Xanh (Đã đóng), Xám/Đỏ (Chưa đóng).

## 5. Git Branch

**Branch name**: `feature/FE-04-fee-management`